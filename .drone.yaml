kind: pipeline
type: kubernetes
name: default
steps:
- name: lint
  image: ruby:2.7.1-buster
  commands:
  - gem install mdl
  - mdl README.md
- name: build on tag
  image: plugins/docker
  settings:
    registry: registry.internal.zespre.com
    repo: registry.internal.zespre.com/starbops/blog
    tags:
    - ${DRONE_TAG##v}-${DRONE_COMMIT_SHA:0:7}
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
  build_args:
  - JEKYLL_ENV=production
  when:
    event:
    - tag
- name: build on push
  image: plugins/docker
  settings:
    registry: registry.internal.zespre.com
    repo: registry.internal.zespre.com/starbops/blog
    tags:
    - latest
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
  build_args:
  - JEKYLL_ENV=development
  when:
    event:
    - push
